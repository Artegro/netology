# Домашнее задание к занятию «Компоненты Kubernetes»

### Цель задания

Рассчитать требования к кластеру под проект

------

### Инструменты и дополнительные материалы, которые пригодятся для выполнения задания:

- [Considerations for large clusters](https://kubernetes.io/docs/setup/best-practices/cluster-large/),
- [Architecting Kubernetes clusters — choosing a worker node size](https://learnk8s.io/kubernetes-node-size).

------

### Задание. Необходимо определить требуемые ресурсы
Известно, что проекту нужны база данных, система кеширования, а само приложение состоит из бекенда и фронтенда. Опишите, какие ресурсы нужны, если известно:

1. Необходимо упаковать приложение в чарт для деплоя в разные окружения. 
2. База данных должна быть отказоустойчивой. Потребляет 4 ГБ ОЗУ в работе, 1 ядро. 3 копии. 
3. Кеш должен быть отказоустойчивый. Потребляет 4 ГБ ОЗУ в работе, 1 ядро. 3 копии. 
4. Фронтенд обрабатывает внешние запросы быстро, отдавая статику. Потребляет не более 50 МБ ОЗУ на каждый экземпляр, 0.2 ядра. 5 копий. 
5. Бекенд потребляет 600 МБ ОЗУ и по 1 ядру на копию. 10 копий.

----

### Ответ

2.  Давайте посчитаем ресурсы , допустим, что база данных и кешь у нас так же будут кластеризированы в к8s.     
    Получаем что там надо:  
        БД (4Гб и 1 ядро)*3 = 12Гб 3 ядра  
        Кеш  (4Гб и 1 ядро)*3 = 12Гб 3 ядра  
        Фронт (50Мб 0.2 ядра)*5 = 250Мб 1 ядро  
        Бек (600Мб 1 ядро)* 10 = 6Гб 10 ядер  
    Итого получаем что нам надо ресурсов на namespase для нашего кластера `30250Мб 17 ядер` но это без расчета релизов , если нам надо будет обновить версию то минимально нам надо добавить ресурсов на одну ноду , и так как самая прожёрливая  нас дона для базы данных и кеша то добавляем  еще `4Гб и 1 ядро` и получаем искомы минимальные `34250Мб 18 ядер`.  это без учета нагрузки ос хостовых на нодах, их пока не считаем так как мы пока не решили сколько нам надо нод.

3.  Ну по факту с этим справиться даже одна нода с процессором что то `Е5 2690 и озу 48Гб`, но давайте будем считать что нам надо отказоустойчивый кластер , тогда у нас должно быть минимум 3 ноды  при чем желательно чтоб все 3 были мастернодами для кворума. ресурсы по нодам разделим так  `6 ядер и 12Гб` на ноду ядер можно и по 6, но давате оставим немного на хостовую систему , как и немного озу.

4.  Добавляем запас на выход из строя ноды +`6 ядер 12Гб` на кластер из 3-х нод, получаем на ноду `9 ядер 18Гб`.

5.  Так как у нас все 3 мастерноды а минимальные требования к ним `2 ядра 2Гб`. 
Расчем для кубилета, так как  накинуть проценты от ядра мы не можем до накидываем 1 ядро (6% от первого ядра. 1% следующего ядра (до 2 ядер).0,5% следующих двух ядер (до 4).)  по памяти (25% от первых 4Гб памяти. 20% от следующих 4 ГБ памяти (до 8 ГБ).010% от следующих 8 ГБ памяти (до 16 ГБ) 6% от следующих 112Гб памяти (до 128Гб)) получаем нам надо  25% от 4Гб + 20% от 4Гб и + 10% от 8Гб + 6% от 2Гб получаем 1+0,8+0,8+0,12 = 2,72Гб. Гб немного округлим и получаем по 5Гб.  
Нам остается накинуть по `3 ядра и 5Гб`, на ноду . Итого конфигурация получается `12 ядер 23Гб` минимальная конфигурация необходимая для отказоустойчикого кластера, 

6.  Поучаем 3 мастерноды на которых и происходит деплой с параметрами `12 ядер 23Гб`  
    Сумарно мы получаем затробованные ресурсы в `36 ядра 69Гб` довольно прожорливо


####  Давайте рассмотрим вариант когда мы сделам 5 нод при чем у нас будет 3 мастер ноды "играющие" и 2 ворк ноды для экономии ресурсов 

3.  Посчитаем скольк нам надо ресурсов на ноду, берем данные по кластеру из пункта 2, получаем и округляем немного `34250Мб 18 ядер`/5 = `4 ядра 7Гб`  на ноду  

4. Добавляем запас на выход из строя ноды + `4 ядра 7Гб` на кластер = `5 ядрер 9Гб`  

5. Расчем для кубилета, так как  накинуть проценты от ядра мы не можем до накидываем 1 ядро (6% от первого ядра. 1% следующего ядра (до 2 ядер).0,5% следующих двух ядер (до 4).)  по памяти  (25% от первых 4Гб памяти. 20% от следующих 4 ГБ памяти (до 8 ГБ).010% от следующих 8 ГБ памяти (до 16 ГБ)) получаем нам надо  25% от 4Гб + 20% от 4Гб и + 10% от 1Гб получаем 1+0,8+0,2 = 1,9Гб   немного округлим 2Гб.  
У нас 3 мастерноды а минимальные требования к ним `2 ядра 2Гб`   добавляем к 3-м нодам и получаем 3 ноды `8 ядер 12,5Гб`.  
На ворк ноды добавляем `1 ядра 2Гб`  получаем `6 ядер 10,5Гб`

6.  3 матерноды по `8 ядер 12,5Гб`  и 2 ворк ноды по `6 ядер 10,5Гб`  сумарно получаем ресурсы кластера `36 ядро 48,5Гб`

### Итог , оказывается более выгодно содержать кластре из 3-х нод чем 5 в кластере из 5 нод мы выигрываем по ресуркам в памяти из за меньшего необходимого количества резервирования ресурков на выход одной ноды.



### Правила приёма работы

1. Домашняя работа оформляется в своем Git-репозитории в файле README.md. Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.
2. Сначала сделайте расчёт всех необходимых ресурсов.
3. Затем прикиньте количество рабочих нод, которые справятся с такой нагрузкой.
4. Добавьте к полученным цифрам запас, который учитывает выход из строя как минимум одной ноды. 
5. Добавьте служебные ресурсы к нодам. Помните, что для разных типов нод требовния к ресурсам разные. 
6. В результате должно быть указано количество нод и их параметры.

